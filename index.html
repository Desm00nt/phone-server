<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Server Panel</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',system-ui,sans-serif;background:#0a0a1a;color:#e0e0e0;min-height:100vh}
        .header{background:linear-gradient(135deg,#1a1a3e,#2d1b69);padding:16px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid #6c63ff;position:sticky;top:0;z-index:100}
        .header h1{font-size:22px;color:#fff}
        .header h1 span{color:#6c63ff}
        .header-right{display:flex;align-items:center;gap:14px}
        .status-badge{background:#00c853;color:#000;padding:5px 14px;border-radius:20px;font-weight:bold;font-size:12px;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        .btn-logout{background:#ff525230;color:#ff5252;border:1px solid #ff525050;padding:5px 14px;border-radius:8px;cursor:pointer;font-size:12px;text-decoration:none;transition:all .2s}
        .btn-logout:hover{background:#ff5252;color:#fff}
        .tabs{display:flex;background:#0f0f25;border-bottom:1px solid #2a2a4a;padding:0 20px;overflow-x:auto}
        .tab{padding:14px 24px;cursor:pointer;color:#888;font-size:14px;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;user-select:none}
        .tab:hover{color:#ccc}
        .tab.active{color:#6c63ff;border-bottom-color:#6c63ff}
        .tab-content{display:none;padding:24px}
        .tab-content.active{display:block}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .card{background:#12122a;border-radius:16px;padding:24px;border:1px solid #2a2a4a;transition:all .3s}
        .card:hover{border-color:#6c63ff40}
        .card h2{color:#6c63ff;margin-bottom:18px;font-size:15px;text-transform:uppercase;letter-spacing:1px}
        .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .stat-item{background:#1a1a3a;padding:16px;border-radius:12px;text-align:center}
        .stat-value{font-size:26px;font-weight:bold;color:#6c63ff}
        .stat-label{font-size:11px;color:#666;margin-top:4px;text-transform:uppercase}
        .progress-bar{width:100%;height:8px;background:#1a1a3a;border-radius:4px;margin-top:8px;overflow:hidden}
        .progress-fill{height:100%;border-radius:4px;transition:width .5s;background:linear-gradient(90deg,#6c63ff,#ff6584)}
        .terminal-box{background:#0a0a16;border-radius:14px;overflow:hidden;border:1px solid #2a2a4a}
        .terminal-header{background:#1a1a3a;padding:10px 16px;display:flex;align-items:center;gap:8px}
        .dot{width:12px;height:12px;border-radius:50%}
        .dot.r{background:#ff5f56}.dot.y{background:#ffbd2e}.dot.g{background:#27ca40}
        .terminal-output{padding:16px;height:400px;overflow-y:auto;font-family:'Fira Code',Consolas,monospace;font-size:13px;line-height:1.7;white-space:pre-wrap}
        .terminal-output .cmd{color:#6c63ff}
        .terminal-output .stdout{color:#a0e0a0}
        .terminal-output .stderr{color:#ff6b6b}
        .terminal-input-wrap{display:flex;border-top:1px solid #2a2a4a}
        .terminal-prompt{padding:12px 16px;color:#6c63ff;font-family:monospace;background:#0a0a16}
        .terminal-input{flex:1;background:#0a0a16;border:none;color:#e0e0e0;font-family:'Fira Code',monospace;font-size:14px;padding:12px 0;outline:none}
        .service-item{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#1a1a3a;border-radius:12px;margin-bottom:10px;border:1px solid #2a2a4a}
        .service-dot{width:10px;height:10px;border-radius:50%;background:#00c853;margin-right:12px;flex-shrink:0}
        .service-info{flex:1}
        .service-name{font-weight:bold;font-size:14px}
        .service-meta{font-size:11px;color:#666;margin-top:3px}
        .service-actions{display:flex;gap:6px}
        .btn{padding:7px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:all .2s}
        .btn:hover{transform:scale(1.05)}
        .btn-start{background:#00c853;color:#000}
        .btn-stop{background:#ff5252;color:#fff}
        .btn-restart{background:#ff9800;color:#000}
        .btn-primary{background:#6c63ff;color:#fff}
        .btn-danger{background:#ff525230;color:#ff5252;border:1px solid #ff525050}
        .btn-sm{padding:5px 12px;font-size:11px}
        .form-row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
        .form-row input{background:#1a1a3a;border:1px solid #2a2a4a;color:#e0e0e0;padding:10px 14px;border-radius:8px;font-size:13px;outline:none;flex:1;min-width:120px}
        .form-row input:focus{border-color:#6c63ff}
        .service-logs{background:#0a0a16;padding:12px;border-radius:10px;margin-top:12px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:12px;line-height:1.5;border:1px solid #1a1a3a}
        .log-stdout{color:#a0e0a0}
        .log-stderr{color:#ff6b6b}
        .file-toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
        .file-path-display{background:#1a1a3a;padding:10px 16px;border-radius:8px;font-family:monospace;font-size:13px;color:#6c63ff;flex:1;min-width:200px}
        .file-list{max-height:500px;overflow-y:auto}
        .file-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;cursor:pointer;transition:background .15s;border-bottom:1px solid #1a1a2a}
        .file-item:hover{background:#1a1a3a}
        .file-icon{font-size:20px;flex-shrink:0}
        .file-name{flex:1;font-size:14px;word-break:break-all}
        .file-meta{color:#666;font-size:12px;text-align:right;min-width:80px}
        .file-actions{display:flex;gap:4px}
        .upload-zone{border:2px dashed #2a2a4a;border-radius:14px;padding:40px;text-align:center;cursor:pointer;transition:all .3s;margin-top:16px}
        .upload-zone:hover,.upload-zone.drag-over{border-color:#6c63ff;background:#6c63ff10}
        .upload-zone .uicon{font-size:48px;margin-bottom:12px}
        .upload-zone p{color:#888;font-size:14px}
        .upload-progress{margin-top:12px;display:none}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:#000000cc;z-index:200;justify-content:center;align-items:center;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:#12122a;border-radius:16px;width:90%;max-width:900px;max-height:90vh;overflow:hidden;border:1px solid #2a2a4a}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #2a2a4a}
        .modal-header h3{color:#6c63ff;font-size:16px}
        .modal-close{background:none;border:none;color:#888;font-size:24px;cursor:pointer}
        .modal-body{padding:20px;overflow-y:auto;max-height:70vh}
        .editor-textarea{width:100%;min-height:400px;background:#0a0a16;border:1px solid #2a2a4a;color:#e0e0e0;padding:16px;font-family:'Fira Code',monospace;font-size:13px;border-radius:10px;outline:none;resize:vertical;line-height:1.6}
        .modal-footer{padding:14px 20px;border-top:1px solid #2a2a4a;display:flex;justify-content:flex-end;gap:10px}
        .settings-group{background:#1a1a3a;padding:20px;border-radius:12px;margin-bottom:16px}
        .settings-group h3{color:#6c63ff;margin-bottom:14px;font-size:14px}
        .settings-row{display:flex;gap:12px;margin-bottom:10px}
        .settings-row input{flex:1;background:#12122a;border:1px solid #2a2a4a;color:#e0e0e0;padding:10px 14px;border-radius:8px;outline:none;font-size:13px}
        .toast{position:fixed;bottom:30px;right:30px;padding:14px 24px;border-radius:10px;color:#fff;font-size:14px;z-index:300;transform:translateY(100px);opacity:0;transition:all .3s}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{background:#00c853}
        .toast.error{background:#ff5252}
        .toast.info{background:#6c63ff}
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:#0a0a1a}
        ::-webkit-scrollbar-thumb{background:#2a2a4a;border-radius:3px}
    </style>
</head>
<body>

<div class="header">
    <h1>üì± <span>Phone</span> Server</h1>
    <div class="header-right">
        <div class="status-badge">‚óè ONLINE</div>
        <a href="/logout" class="btn-logout">–í—ã–π—Ç–∏</a>
    </div>
</div>

<div class="tabs">
    <div class="tab active" data-tab="dashboard">üìä –î–∞—à–±–æ—Ä–¥</div>
    <div class="tab" data-tab="terminal">üíª –¢–µ—Ä–º–∏–Ω–∞–ª</div>
    <div class="tab" data-tab="services">ü§ñ –°–µ—Ä–≤–∏—Å—ã</div>
    <div class="tab" data-tab="files">üìÅ –§–∞–π–ª—ã</div>
    <div class="tab" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>

<!-- DASHBOARD -->
<div class="tab-content active" id="tab-dashboard">
    <div class="grid">
        <div class="card">
            <h2>üìä –°–∏—Å—Ç–µ–º–∞</h2>
            <div class="stat-grid">
                <div class="stat-item"><div class="stat-value" id="s-cpu">-</div><div class="stat-label">CPU Cores</div></div>
                <div class="stat-item"><div class="stat-value" id="s-proc">-</div><div class="stat-label">–ü—Ä–æ—Ü–µ—Å—Å—ã</div></div>
                <div class="stat-item"><div class="stat-value" id="s-uptime">-</div><div class="stat-label">Uptime</div></div>
                <div class="stat-item"><div class="stat-value" id="s-services">0</div><div class="stat-label">–°–µ—Ä–≤–∏—Å—ã</div></div>
            </div>
            <div style="margin-top:18px">
                <div style="display:flex;justify-content:space-between;font-size:13px"><span>üíæ RAM</span><span id="s-mem-text">-</span></div>
                <div class="progress-bar"><div class="progress-fill" id="s-mem-bar" style="width:0%"></div></div>
            </div>
            <div style="margin-top:14px">
                <div style="display:flex;justify-content:space-between;font-size:13px"><span>üíø –î–∏—Å–∫</span><span id="s-disk-text">-</span></div>
                <div class="progress-bar"><div class="progress-fill" id="s-disk-bar" style="width:0%"></div></div>
            </div>
        </div>
        <div class="card">
            <h2>ü§ñ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã</h2>
            <div id="dash-services"><div style="color:#666;text-align:center;padding:30px">–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</div></div>
        </div>
        <div class="card" style="grid-column:1/-1">
            <h2>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h2>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="quickCmd('whoami')">whoami</button>
                <button class="btn btn-primary" onclick="quickCmd('pwd')">pwd</button>
                <button class="btn btn-primary" onclick="quickCmd('df -h')">–î–∏—Å–∫</button>
                <button class="btn btn-primary" onclick="quickCmd('uptime')">Uptime</button>
                <button class="btn btn-primary" onclick="quickCmd('ls -la ~')">Home</button>
                <button class="btn btn-primary" onclick="quickCmd('date')">–î–∞—Ç–∞</button>
            </div>
            <pre id="quick-output" style="background:#0a0a16;padding:14px;border-radius:10px;margin-top:14px;font-size:13px;color:#a0e0a0;min-height:60px;max-height:200px;overflow-y:auto"></pre>
        </div>
    </div>
</div>

<!-- TERMINAL -->
<div class="tab-content" id="tab-terminal">
    <div class="terminal-box">
        <div class="terminal-header">
            <div class="dot r"></div><div class="dot y"></div><div class="dot g"></div>
            <span style="margin-left:12px;font-size:13px;color:#888">Termux Shell</span>
            <button class="btn btn-sm btn-danger" style="margin-left:auto" onclick="clearTerminal()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="terminal-output" id="term-out"><span class="stdout">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Phone Server Terminal! üöÄ
–í–≤–æ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∏–∂–µ.
</span></div>
        <div class="terminal-input-wrap">
            <span class="terminal-prompt">$</span>
            <input type="text" class="terminal-input" id="term-in" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É...">
        </div>
    </div>
</div>

<!-- SERVICES -->
<div class="tab-content" id="tab-services">
    <div class="card">
        <h2>‚ûï –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å</h2>
        <div class="form-row">
            <input type="text" id="new-svc-name" placeholder="–ò–º—è (–Ω–∞–ø—Ä: telegram-bot)">
            <input type="text" id="new-svc-cmd" placeholder="–ö–æ–º–∞–Ω–¥–∞ (–Ω–∞–ø—Ä: python bot.py)">
            <input type="text" id="new-svc-cwd" placeholder="–ü–∞–ø–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button class="btn btn-start" onclick="startService()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
    <div style="margin-top:20px" id="services-container">
        <div style="color:#666;text-align:center;padding:40px">–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</div>
    </div>
</div>

<!-- FILES -->
<div class="tab-content" id="tab-files">
    <div class="card">
        <div class="file-toolbar">
            <div class="file-path-display" id="file-path">~</div>
            <button class="btn btn-primary btn-sm" onclick="goHome()">üè† Home</button>
            <button class="btn btn-primary btn-sm" onclick="createFolder()">üìÅ –ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
            <button class="btn btn-primary btn-sm" onclick="document.getElementById('file-upload-input').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div class="file-list" id="file-list"></div>
        <div class="upload-zone" id="upload-zone">
            <div class="uicon">üì§</div>
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
            <p style="font-size:12px;margin-top:8px;color:#555">–ú–∞–∫—Å–∏–º—É–º 500MB –Ω–∞ —Ñ–∞–π–ª</p>
            <input type="file" id="file-upload-input" multiple style="display:none">
        </div>
        <div class="upload-progress" id="upload-progress">
            <div class="progress-bar"><div class="progress-fill" id="upload-bar" style="width:0%"></div></div>
            <div style="font-size:12px;color:#888;margin-top:6px" id="upload-status"></div>
        </div>
    </div>
</div>

<!-- SETTINGS -->
<div class="tab-content" id="tab-settings">
    <div class="grid">
        <div class="card">
            <h2>üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2>
            <div class="settings-group">
                <div class="settings-row"><input type="password" id="cur-pass" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"></div>
                <div class="settings-row"><input type="password" id="new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"></div>
                <div class="settings-row"><input type="password" id="new-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
                <button class="btn btn-primary" onclick="changePassword()" style="margin-top:8px">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
        </div>
        <div class="card">
            <h2>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div class="settings-group">
                <p style="font-size:13px;color:#aaa;line-height:1.8">
                    üì± <strong>Phone Server Panel</strong><br>
                    –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º-—Å–µ—Ä–≤–µ—Ä–æ–º.<br><br>
                    üåê Panel: <code>http://IP:3000</code>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- EDITOR MODAL -->
<div class="modal-overlay" id="editor-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="editor-title">–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
            <button class="modal-close" onclick="closeEditor()">x</button>
        </div>
        <div class="modal-body">
            <textarea class="editor-textarea" id="editor-content"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="closeEditor()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="saveFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
var socket = io();
var currentFilePath = '';
var editingFilePath = '';
var cmdHistory = [];
var historyIdx = -1;

// TABS
document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

// TOAST
function showToast(msg, type) {
    if (!type) type = 'info';
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type + ' show';
    setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// SYSTEM
function updateSystem() {
    fetch('/api/system').then(function(r) { return r.json(); }).then(function(d) {
        document.getElementById('s-cpu').textContent = d.cpus;
        document.getElementById('s-proc').textContent = d.processes;
        document.getElementById('s-mem-text').textContent = d.usedMemory + 'MB / ' + d.totalMemory + 'MB';
        document.getElementById('s-mem-bar').style.width = d.memoryPercent + '%';
        document.getElementById('s-disk-text').textContent = d.diskUsed + ' / ' + d.diskTotal;
        document.getElementById('s-disk-bar').style.width = d.diskPercent + '%';
        var h = Math.floor(d.uptime / 3600);
        var m = Math.floor((d.uptime % 3600) / 60);
        document.getElementById('s-uptime').textContent = h + 'h ' + m + 'm';
    }).catch(function() {});
}

// QUICK CMD
function quickCmd(cmd) {
    fetch('/api/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: cmd })
    }).then(function(r) { return r.json(); }).then(function(d) {
        var out = d.stdout;
        if (!out) out = d.stderr;
        if (!out) out = d.error;
        if (!out) out = 'OK';
        document.getElementById('quick-output').textContent = out;
    });
}

// TERMINAL
var termIn = document.getElementById('term-in');
termIn.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        var cmd = termIn.value.trim();
        if (!cmd) return;
        cmdHistory.unshift(cmd);
        historyIdx = -1;
        appendTerm('$ ' + cmd, 'cmd');
        socket.emit('terminal-input', { command: cmd });
        termIn.value = '';
    }
    if (e.key === 'ArrowUp') {
        historyIdx = Math.min(historyIdx + 1, cmdHistory.length - 1);
        termIn.value = cmdHistory[historyIdx] ? cmdHistory[historyIdx] : '';
        e.preventDefault();
    }
    if (e.key === 'ArrowDown') {
        historyIdx = Math.max(historyIdx - 1, -1);
        termIn.value = historyIdx >= 0 ? cmdHistory[historyIdx] : '';
        e.preventDefault();
    }
});

socket.on('terminal-output', function(data) {
    if (data.stdout) appendTerm(data.stdout, 'stdout');
    if (data.stderr) appendTerm(data.stderr, 'stderr');
});

function appendTerm(text, cls) {
    var out = document.getElementById('term-out');
    var span = document.createElement('span');
    span.className = cls;
    span.textContent = text + (text.endsWith('\n') ? '' : '\n');
    out.appendChild(span);
    out.scrollTop = out.scrollHeight;
}

function clearTerminal() {
    document.getElementById('term-out').innerHTML = '<span class="stdout">–¢–µ—Ä–º–∏–Ω–∞–ª –æ—á–∏—â–µ–Ω.\n</span>';
}

// SERVICES
function updateServices() {
    fetch('/api/services').then(function(r) { return r.json(); }).then(function(data) {
        var entries = Object.entries(data);
        document.getElementById('s-services').textContent = entries.length;

        var dash = document.getElementById('dash-services');
        if (entries.length === 0) {
            dash.innerHTML = '<div style="color:#666;text-align:center;padding:20px">–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</div>';
        } else {
            var html = '';
            entries.forEach(function(entry) {
                var name = entry[0];
                var info = entry[1];
                html += '<div class="service-item"><div class="service-dot"></div><div class="service-info"><div class="service-name">' + escapeHtml(name) + '</div><div class="service-meta">PID: ' + info.pid + ' | ' + escapeHtml(info.command) + '</div></div></div>';
            });
            dash.innerHTML = html;
        }

        var cont = document.getElementById('services-container');
        if (entries.length === 0) {
            cont.innerHTML = '<div style="color:#666;text-align:center;padding:40px">–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ.</div>';
        } else {
            var html2 = '';
            entries.forEach(function(entry) {
                var name = entry[0];
                var info = entry[1];
                var logsHtml = '';
                if (info.logs) {
                    info.logs.forEach(function(l) {
                        logsHtml += '<span class="log-' + l.type + '">' + escapeHtml(l.text) + '</span>';
                    });
                }
                html2 += '<div class="card" style="margin-bottom:16px">';
                html2 += '<div class="service-item" style="margin-bottom:0">';
                html2 += '<div style="display:flex;align-items:center"><div class="service-dot"></div>';
                html2 += '<div class="service-info"><div class="service-name">' + escapeHtml(name) + '</div>';
                html2 += '<div class="service-meta">PID: ' + info.pid + ' | ' + escapeHtml(info.command) + ' | ' + escapeHtml(info.cwd) + '</div></div></div>';
                html2 += '<div class="service-actions">';
                html2 += '<button class="btn btn-restart btn-sm" onclick="restartService(\'' + escapeAttr(name) + '\')">üîÑ</button>';
                html2 += '<button class="btn btn-stop btn-sm" onclick="stopService(\'' + escapeAttr(name) + '\')">‚ñ† Stop</button>';
                html2 += '</div></div>';
                html2 += '<div class="service-logs" id="logs-' + escapeAttr(name) + '">' + logsHtml + '</div></div>';
            });
            cont.innerHTML = html2;
        }
    }).catch(function() {});
}

function startService() {
    var name = document.getElementById('new-svc-name').value.trim();
    var command = document.getElementById('new-svc-cmd').value.trim();
    var cwd = document.getElementById('new-svc-cwd').value.trim();
    if (!name || !command) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –∫–æ–º–∞–Ω–¥—É', 'error'); return; }
    fetch('/api/service/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, command: command, cwd: cwd ? cwd : undefined })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) {
            showToast('–°–µ—Ä–≤–∏—Å ' + name + ' –∑–∞–ø—É—â–µ–Ω!', 'success');
            document.getElementById('new-svc-name').value = '';
            document.getElementById('new-svc-cmd').value = '';
            document.getElementById('new-svc-cwd').value = '';
            updateServices();
        } else { showToast(d.error, 'error'); }
    });
}

function stopService(name) {
    fetch('/api/service/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name })
    }).then(function() { showToast('–°–µ—Ä–≤–∏—Å ' + name + ' –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info'); setTimeout(updateServices, 500); });
}

function restartService(name) {
    fetch('/api/service/restart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name })
    }).then(function() { showToast('–°–µ—Ä–≤–∏—Å ' + name + ' –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è', 'info'); setTimeout(updateServices, 1500); });
}

socket.on('service-log', function(data) {
    var el = document.getElementById('logs-' + data.service);
    if (el) {
        var span = document.createElement('span');
        span.className = 'log-' + data.type;
        span.textContent = data.data;
        el.appendChild(span);
        el.scrollTop = el.scrollHeight;
    }
});

socket.on('service-stopped', function(data) {
    showToast('–°–µ—Ä–≤–∏—Å ' + data.name + ' –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è (–∫–æ–¥: ' + data.code + ')', 'error');
    setTimeout(updateServices, 500);
});

// FILES
function loadFiles(dirPath) {
    fetch('/api/files?path=' + encodeURIComponent(dirPath ? dirPath : '')).then(function(r) { return r.json(); }).then(function(data) {
        if (data.error) { showToast(data.error, 'error'); return; }
        currentFilePath = data.path;
        document.getElementById('file-path').textContent = currentFilePath;
        var list = document.getElementById('file-list');
        list.innerHTML = '';

        var parent = document.createElement('div');
        parent.className = 'file-item';
        parent.innerHTML = '<span class="file-icon">‚¨ÜÔ∏è</span><span class="file-name">..</span><span class="file-meta">–ù–∞–≤–µ—Ä—Ö</span>';
        parent.onclick = function() {
            var parts = currentFilePath.split('/');
            parts.pop();
            loadFiles(parts.join('/') ? parts.join('/') : '/');
        };
        list.appendChild(parent);

        var sorted = data.items.sort(function(a, b) {
            if (a.isDirectory && !b.isDirectory) return -1;
            if (!a.isDirectory && b.isDirectory) return 1;
            return a.name.localeCompare(b.name);
        });

        sorted.forEach(function(item) {
            var el = document.createElement('div');
            el.className = 'file-item';
            var icon = item.isDirectory ? 'üìÅ' : getFileIcon(item.name);
            var size = item.isDirectory ? '' : formatSize(item.size);
            var fullPath = currentFilePath + '/' + item.name;

            var actionsHtml = '';
            if (!item.isDirectory) {
                actionsHtml += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation();editFile(\'' + escapeAttr(fullPath) + '\')">‚úèÔ∏è</button>';
                actionsHtml += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation();downloadFile(\'' + escapeAttr(fullPath) + '\')">‚¨áÔ∏è</button>';
            }
            actionsHtml += '<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteFile(\'' + escapeAttr(fullPath) + '\',\'' + escapeAttr(item.name) + '\')">üóë</button>';

            el.innerHTML = '<span class="file-icon">' + icon + '</span><span class="file-name">' + escapeHtml(item.name) + '</span><span class="file-meta">' + size + '</span><div class="file-actions">' + actionsHtml + '</div>';

            if (item.isDirectory) {
                el.onclick = function() { loadFiles(fullPath); };
            }
            list.appendChild(el);
        });
    }).catch(function() { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤', 'error'); });
}

function goHome() { loadFiles(''); }

function deleteFile(filePath, name) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å "' + name + '"?')) return;
    fetch('/api/files/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filePath: filePath })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) { showToast('–£–¥–∞–ª–µ–Ω–æ!', 'success'); loadFiles(currentFilePath); }
        else showToast(d.error, 'error');
    });
}

function createFolder() {
    var name = prompt('–ò–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:');
    if (!name) return;
    fetch('/api/files/mkdir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dirPath: currentFilePath + '/' + name })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) { showToast('–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success'); loadFiles(currentFilePath); }
        else showToast(d.error, 'error');
    });
}

function downloadFile(filePath) {
    window.open('/api/files/download?path=' + encodeURIComponent(filePath), '_blank');
}

function editFile(filePath) {
    fetch('/api/files/read?path=' + encodeURIComponent(filePath)).then(function(r) { return r.json(); }).then(function(d) {
        if (d.error) { showToast(d.error, 'error'); return; }
        editingFilePath = filePath;
        document.getElementById('editor-title').textContent = '‚úèÔ∏è ' + filePath.split('/').pop();
        document.getElementById('editor-content').value = d.content;
        document.getElementById('editor-modal').classList.add('active');
    }).catch(function() { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª', 'error'); });
}

function closeEditor() {
    document.getElementById('editor-modal').classList.remove('active');
}

function saveFile() {
    var content = document.getElementById('editor-content').value;
    fetch('/api/files/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filePath: editingFilePath, content: content })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) { showToast('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success'); closeEditor(); }
        else showToast(d.error, 'error');
    });
}

// UPLOAD
var uploadZone = document.getElementById('upload-zone');
var uploadInput = document.getElementById('file-upload-input');
uploadZone.addEventListener('click', function() { uploadInput.click(); });
uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('drag-over'); });
uploadZone.addEventListener('drop', function(e) { e.preventDefault(); uploadZone.classList.remove('drag-over'); handleUpload(e.dataTransfer.files); });
uploadInput.addEventListener('change', function(e) { handleUpload(e.target.files); });

function handleUpload(files) {
    if (!files.length) return;
    var formData = new FormData();
    formData.append('uploadPath', currentFilePath ? currentFilePath : '');
    for (var i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    var prog = document.getElementById('upload-progress');
    var bar = document.getElementById('upload-bar');
    var status = document.getElementById('upload-status');
    prog.style.display = 'block';
    status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/upload');
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            var pct = (e.loaded / e.total * 100).toFixed(0);
            bar.style.width = pct + '%';
            status.textContent = pct + '% ‚Äî ' + formatSize(e.loaded) + ' / ' + formatSize(e.total);
        }
    };
    xhr.onload = function() {
        var d = JSON.parse(xhr.responseText);
        if (d.success) {
            showToast(d.files.length + ' —Ñ–∞–π–ª(–æ–≤) –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
            loadFiles(currentFilePath);
        } else { showToast(d.error, 'error'); }
        setTimeout(function() { prog.style.display = 'none'; bar.style.width = '0%'; }, 2000);
    };
    xhr.onerror = function() { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'); prog.style.display = 'none'; };
    xhr.send(formData);
    uploadInput.value = '';
}

// SETTINGS
function changePassword() {
    var cur = document.getElementById('cur-pass').value;
    var n1 = document.getElementById('new-pass').value;
    var n2 = document.getElementById('new-pass2').value;
    if (!cur || !n1) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error'); return; }
    if (n1 !== n2) { showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error'); return; }
    if (n1.length < 4) { showToast('–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error'); return; }
    fetch('/api/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword: cur, newPassword: n1 })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.success) {
            showToast('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!', 'success');
            document.getElementById('cur-pass').value = '';
            document.getElementById('new-pass').value = '';
            document.getElementById('new-pass2').value = '';
        } else { showToast(d.error, 'error'); }
    });
}

// HELPERS
function escapeHtml(s) {
    if (!s) return '';
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
function escapeAttr(s) {
    if (!s) return '';
    return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}
function formatSize(b) {
    if (b > 1073741824) return (b / 1073741824).toFixed(1) + ' GB';
    if (b > 1048576) return (b / 1048576).toFixed(1) + ' MB';
    if (b > 1024) return (b / 1024).toFixed(1) + ' KB';
    return b + ' B';
}
function getFileIcon(name) {
    var ext = name.split('.').pop().toLowerCase();
    var icons = {py:'üêç',js:'üìú',json:'üìã',html:'üåê',css:'üé®',md:'üìù',txt:'üìÑ',log:'üìã',sh:'‚ö°',png:'üñº',jpg:'üñº',mp3:'üéµ',mp4:'üé¨',zip:'üì¶',pdf:'üìï'};
    return icons[ext] ? icons[ext] : 'üìÑ';
}

// INIT
updateSystem();
loadFiles('');
updateServices();
setInterval(updateSystem, 5000);
setInterval(updateServices, 5000);
</script>
</body>
</html>
